#wget of file based on country name:
#
#http://www.ipdeny.com/ipblocks/data/countries/cn.zone
#
#accept options: right now just do COUNTRY and PORT (port to block or ALL)
#
#then
#
#for i in $(cat cn.zone) ; do iptables -A INPUT -s $i -j DROP; done
#iptables -D INPUT -i eth0 -p tcp --dport 443 -j ACCEPT  to remove (D rather than A)

#!/bin/bash

countryList="inc/countryList"


if [ "$EUID" -ne 0 ]
  then echo "Because this script generates and applies IPtables rules, root level access is required."
  exit
fi

echo -n "Enter the country to block [ENTER]: "
read Country
echo -n "Enter the specific port number to block or ALL to block all access [ENTER]: "
read Port


echo "Country = $Country";
echo "Port = $Port";

while true
	do
		echo -n "Please confirm (y or n) :"
		read CONFIRM
		case $CONFIRM in
			y|Y|YES|yes|Yes) break ;;
			n|N|no|NO|No)
		echo Aborting - you entered $CONFIRM
		exit
		;;
		*) echo Please enter only y or n
	esac
	done
echo You entered $CONFIRM. Continuing ...

#Check to ensure there's only one match:
matchCount=$(grep $Country $countryList | awk '{print $1}' | wc -l);

if [ $matchCount -eq 1 ] ; then

	countryCode=$(grep $Country $countryList | awk '{print $1}' | tr "[:upper:]" "[:lower:]")
	countryName=$(grep $Country $countryList | awk '{print $2}')

	echo "$countryName is the 2 letter abbreviation: $countryCode";
	echo "Obtaining IP blocks now..."
	wget -P /tmp http://www.ipdeny.com/ipblocks/data/countries/$countryCode.zone
	echo "Formulating IPTables rules..."
	echo

	echo "#!/bin/bash" > /tmp/sanction.$countryCode.rules;
	echo "#!/bin/bash" > /tmp/sanction.remove.$countryCode.rules;

	if [ $Port = "ALL" ] ; then
	
		for i in $(cat /tmp/$countryCode.zone) ; 
			do echo "iptables -A INPUT -s $i -j DROP" >> /tmp/sanction.$countryCode.rules; 
		done
                for i in $(cat /tmp/$countryCode.zone) ;
                        do echo "iptables -D INPUT -s $i -j DROP" >> /tmp/sanction.remove.$countryCode.rules;
                done

	else
		for i in $(cat /tmp/$countryCode.zone) ;
			do echo "iptables -A INPUT -s $i -p tcp --dport $Port -j DROP" >> /tmp/sanction.$countryCode.rules;
		done
		for i in $(cat /tmp/$countryCode.zone) ;
                        do echo "iptables -D INPUT -s $i -p tcp --dport $Port -j DROP" >> /tmp/sanction.remove.$countryCode.rules;
                done
	fi

	echo
	echo "Applying IPtables rules..."
	echo
	chmod +x /tmp/sanction.$countryCode.rules;
	chmod +x /tmp/sanction.remove.$countryCode.rules;
	/tmp/sanction.$countryCode.rules;
	
	echo "Rules applied. To remove them, run the command:"
	echo
	echo "/tmp/sanction.remove.$countryCode.rules"
	echo
	echo "or just restart iptables."
	

else 
	echo
	echo "Warning!"
	echo "There were $matchCount entries that matched the country you entered:";
	echo
	grep $Country $countryList | awk '{ $1=""; print $0}';
	echo
	echo "Please re-run this script and be explicit in which one you meant to prevent issues."
	
fi
